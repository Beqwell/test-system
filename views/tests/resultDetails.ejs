<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Result Details</title>
  <style>
    .edit-panel   { margin-top: 10px; }
    .hidden       { display: none; }
    .readonly-note{ color: gray; font-size: 13px; }
  </style>
</head>
<body>
  <h1>Result Details</h1>

  <% questions.forEach((q, i) => {
      const answer    = q.answers.find(a => a.is_checked) || q.answers[0];
      const isChecked = answer?.is_checked === true;
      const accuracy  = answer?.accuracy_percent;
      const answerId  = answer?.id;
  %>
    <div style="margin-bottom:25px; padding:10px; border:1px solid #ccc;">
      <strong><%= i + 1 %>. <%= q.question_text %></strong><br><br>
        <%- renderAttachmentHTML(q.attachment_path) %>


      <% if (q.question_type === 'one' || q.question_type === 'multi') { %>
        <ul>
          <% q.answers.forEach(a => { %>
            <li>
              <%= a.text %>
              <% if (a.is_selected) { %> ‚Äî <strong>Selected</strong><% } %>
              <% if (a.is_correct)  { %> ‚Äî <em>(Correct answer)</em><% } %>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p><strong>Student answer:</strong> <%= q.student_answers?.[0] || '(no answer)' %></p>
        <% if (q.expected_answer) { %>
          <p><strong>Expected:</strong> <%= q.expected_answer %></p>
        <% } %>
      <% } %>

      <% if (isChecked) { %>
        <div id="readonly-<%= answerId %>">
          <div class="readonly-note">Graded ‚Äî can be edited</div>
          <strong>Result:</strong>
          <% if (accuracy === 100) { %> ‚úÖ Correct
          <% } else if (accuracy === 0) { %> ‚ùå Incorrect
          <% } else { %> <%= accuracy %>% correct
          <% } %>
          <br><br>
          <button onclick="showEditMode('<%= answerId %>')">Edit Result</button>
        </div>
      <% } %>

      <div id="form-mode-<%= answerId %>" class="edit-panel <%= isChecked ? 'hidden' : '' %>">
        <form method="POST" action="/answer/<%= answerId %>/evaluate">
          <!-- –ø–µ—Ä–µ–¥–∞—ë–º result_id –∏ question_id –¥–ª—è –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–≥–æ –∞–ø–¥–µ–π—Ç–∞ -->
          <input type="hidden" name="result_id"   value="<%= resultId   %>">
          <input type="hidden" name="question_id" value="<%= q.id        %>">

          <!-- ‚úÖ/‚ùå Mode -->
          <div id="bool-block-<%= answerId %>">
            <label><input type="radio" name="is_correct" value="true"> ‚úÖ Correct</label>
            <label><input type="radio" name="is_correct" value="false"> ‚ùå Incorrect</label>
            <br><br>
            <button type="button" onclick="switchToAccuracy('<%= answerId %>')">
              Switch to Accuracy %
            </button>
            <br><br>
            <button type="submit">Save</button>
          </div>

          <!-- % Mode -->
          <div id="accuracy-block-<%= answerId %>" class="hidden">
            <label>Accuracy (%):</label>
            <input type="number"
                   id="accuracy-input-<%= answerId %>"
                   min="0" max="100"
                   value="<%= accuracy ?? '' %>"
                   required>
            <br><br>
            <button type="button" onclick="switchToBool('<%= answerId %>')">
              Back to Correct/Incorrect
            </button>
            <br><br>
            <button type="submit">Save</button>
          </div>

        </form>
      </div>
    </div>
  <% }) %>

  <% 
    // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω
    const allChecked = questions.every(q => q.answers.some(a => a.is_checked)); 
  %>

  <% if (allChecked) { %>
    <div style="margin-bottom:1em;">
      <strong>Preview Score:</strong> <%= previewPercent %>%  
      <span style="color: gray; font-size: 0.9em;">
        (what student will get)
      </span>
    </div>
  <% } else { %>
    <div style="margin-bottom:1em; color: darkred;">
      –ù–µ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    </div>
  <% } %>

  <form method="POST" action="/result/<%= resultId %>/recalculate">
    <button type="submit"
      <%= !allChecked ? 'disabled' : '' %>>
      üíæ Save Final Result
    </button>
  </form>

  <br><a href="<%= backUrl || '/dashboard' %>">Back</a>

  <script>
    function showEditMode(id) {
      document.getElementById('readonly-' + id)?.classList.add('hidden');
      document.getElementById('form-mode-' + id)?.classList.remove('hidden');
      switchToBool(id);
    }

    function switchToAccuracy(id) {
      document.getElementById(`bool-block-${id}`).classList.add('hidden');
      document.querySelectorAll(`#bool-block-${id} input[name="is_correct"]`)
              .forEach(el => el.removeAttribute('name'));

      document.getElementById(`accuracy-block-${id}`).classList.remove('hidden');
      const num = document.getElementById(`accuracy-input-${id}`);
      num.setAttribute('name', 'accuracy_percent');
    }

    function switchToBool(id) {
      document.getElementById(`accuracy-block-${id}`).classList.add('hidden');
      const num = document.getElementById(`accuracy-input-${id}`);
      if (num) num.removeAttribute('name');

      const boolBlock = document.getElementById(`bool-block-${id}`);
      boolBlock.classList.remove('hidden');
      boolBlock.querySelectorAll('input[type="radio"]')
               .forEach(el => el.setAttribute('name', 'is_correct'));
    }
  </script>
</body>
</html>
